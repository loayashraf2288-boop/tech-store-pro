<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="style.css">

<title id="title"></title>

</head>

<body>

<nav>

<div class="logo" id="logo"></div>

<input 
class="search"
placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..."
onkeyup="searchProducts(this.value)"
>

</nav>

<div class="container" id="products"></div>


<div class="cartBtn" onclick="toggleCart()">ğŸ›’</div>


<div class="cart" id="cart">

<h2>Ø§Ù„Ø³Ù„Ø©</h2>

<div id="cartItems"></div>

<h3 id="total"></h3>

<hr>

<div class="checkout">

<input id="name" placeholder="Ø§Ù„Ø§Ø³Ù…">
<input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
<input id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
<input id="apartment" placeholder="Ø§Ù„Ø´Ù‚Ø©">
<input id="floor" placeholder="Ø§Ù„Ø¯ÙˆØ±">

<button onclick="checkout()">
Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
</button>

</div>

</div>



<script>

// ğŸ”¥ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±

fetch("/store-name")
.then(r=>r.json())
.then(data=>{

document.getElementById("logo").innerText="ğŸ”¥ "+data.name;
document.getElementById("title").innerText=data.name;

});



let allProducts=[];
let cart=[];

const productsDiv = document.getElementById("products");

fetch("/api/products")
.then(r=>r.json())
.then(data=>{
allProducts=data;
render(data);
});



function render(products){

productsDiv.innerHTML="";

products.forEach(p=>{

productsDiv.innerHTML+=`

<div class="card"
onclick="location.href='product.html?id=${p.id}'">

<img src="${p.images[0]}">

<h3>${p.name}</h3>

${p.discount ? 
`<small style="text-decoration:line-through">
${p.price}
</small>` : ""}

<div class="price">
${p.discount ? p.price-p.discount : p.price} Ø¬Ù†ÙŠÙ‡
</div>

<p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${p.stock}</p>

<button onclick='event.stopPropagation(); addToCart(${JSON.stringify(p)})'>
Ø§Ø¶Ù Ù„Ù„Ø³Ù„Ø©
</button>

</div>

`;

});

}



// SEARCH

function searchProducts(val){

const filtered = allProducts.filter(p=>
p.name.toLowerCase().includes(val.toLowerCase())
);

render(filtered);
}



// CART

function toggleCart(){
document.getElementById("cart")
.classList.toggle("showCart");
}



function addToCart(product){

const existing = cart.find(p=>p.id===product.id);

if(existing){
existing.qty++;
}else{
product.qty=1;
cart.push(product);
}

updateCart();

}



function updateCart(){

cartItems.innerHTML="";

let totalPrice=0;

cart.forEach(p=>{

const price = p.discount ? p.price-p.discount : p.price;

totalPrice += price * p.qty;

cartItems.innerHTML+=`

<div style="margin:10px 0">

<b>${p.name}</b>

<br>

${price} Ã— ${p.qty}

<div>

<button onclick="changeQty(${p.id},-1)">-</button>
<button onclick="changeQty(${p.id},1)">+</button>

</div>

</div>

`;

});

document.getElementById("total")
.innerText="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+totalPrice+" Ø¬Ù†ÙŠÙ‡";

}



function changeQty(id,num){

const item = cart.find(p=>p.id===id);

item.qty += num;

if(item.qty<=0){
cart = cart.filter(p=>p.id!==id);
}

updateCart();

}



// CHECKOUT

function checkout(){

if(!name.value || !phone.value || !address.value){
alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
return;
}

fetch("/api/orders",{
method:"POST",
headers:{
"Content-Type":"application/json"
},
body:JSON.stringify({

customer:{
name:name.value,
phone:phone.value,
address:address.value,
apartment:apartment.value,
floor:floor.value
},

cart

})
});

alert("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ ğŸ”¥");

cart=[];
updateCart();

}

</script>

</body>
</html>
